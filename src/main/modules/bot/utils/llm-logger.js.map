{
  "version": 3,
  "sources": ["llm-logger.ts"],
  "sourcesContent": ["/**\n * LLM Logger - API Call Logging and Cost Tracking\n * \n * Logs all LLM API calls with usage metrics and costs.\n * Port of Python's src/ai/llm_logger.py\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { createLogger } from '../utils/logger';\nimport { getDataFolderPath } from '../utils/paths';\nimport type { ChatMessage, TokenUsage } from '../ai/backend-client';\n\nconst log = createLogger('LLMLogger');\n\n/**\n * Pricing configuration for different models\n */\nconst MODEL_PRICING: Record<string, { input: number; output: number }> = {\n  'gpt-4o-mini': {\n    input: 0.00000015,  // $0.15 per 1M tokens\n    output: 0.0000006,  // $0.60 per 1M tokens\n  },\n  'gpt-4o': {\n    input: 0.000005,    // $5.00 per 1M tokens\n    output: 0.000015,   // $15.00 per 1M tokens\n  },\n  'gpt-4': {\n    input: 0.00003,     // $30.00 per 1M tokens\n    output: 0.00006,    // $60.00 per 1M tokens\n  },\n  'gpt-3.5-turbo': {\n    input: 0.0000005,   // $0.50 per 1M tokens\n    output: 0.0000015,  // $1.50 per 1M tokens\n  },\n};\n\n/**\n * Log entry structure\n */\nexport interface LLMLogEntry {\n  model: string;\n  time: string;\n  messages: ChatMessage[];\n  response: string;\n  total_tokens: number;\n  input_tokens: number;\n  output_tokens: number;\n  total_cost: number;\n  finish_reason: string;\n}\n\n/**\n * Logger for LLM API calls with cost tracking\n */\nexport class LLMLogger {\n  private logFilePath: string;\n\n  constructor(logFileName: string = 'llm_calls.json') {\n    const dataFolder = getDataFolderPath();\n    const outputFolder = path.join(dataFolder, 'output');\n\n    // Ensure output folder exists\n    if (!fs.existsSync(outputFolder)) {\n      fs.mkdirSync(outputFolder, { recursive: true });\n    }\n\n    this.logFilePath = path.join(outputFolder, logFileName);\n    log.debug(`LLM logger initialized: ${this.logFilePath}`);\n  }\n\n  /**\n   * Log an API request\n   */\n  logRequest(\n    messages: ChatMessage[],\n    response: string,\n    usage: TokenUsage,\n    model: string,\n    finishReason: string = 'stop'\n  ): void {\n    const currentTime = new Date().toISOString();\n\n    // Calculate cost\n    const pricing = MODEL_PRICING[model] || MODEL_PRICING['gpt-4o-mini'];\n    const totalCost =\n      usage.input_tokens * pricing.input +\n      usage.output_tokens * pricing.output;\n\n    // Log to console\n    log.debug(\n      `Model: ${model}, Tokens: ${usage.total_tokens} ` +\n      `(in:${usage.input_tokens}, out:${usage.output_tokens}), ` +\n      `Cost: $${totalCost.toFixed(6)}`\n    );\n\n    // Create log entry\n    const logEntry: LLMLogEntry = {\n      model,\n      time: currentTime,\n      messages,\n      response,\n      total_tokens: usage.total_tokens,\n      input_tokens: usage.input_tokens,\n      output_tokens: usage.output_tokens,\n      total_cost: totalCost,\n      finish_reason: finishReason,\n    };\n\n    // Append to log file\n    try {\n      const logLine = JSON.stringify(logEntry, null, 2) + '\\n';\n      fs.appendFileSync(this.logFilePath, logLine, 'utf-8');\n      log.debug(`Call logged to ${this.logFilePath}`);\n    } catch (error) {\n      log.warn(`Failed to write to ${this.logFilePath}: ${error}`);\n    }\n  }\n\n  /**\n   * Calculate total usage and cost from log file\n   */\n  getTotalUsage(): {\n    totalCalls: number;\n    totalTokens: number;\n    totalCost: number;\n    byModel: Record<string, { calls: number; tokens: number; cost: number }>;\n  } {\n    if (!fs.existsSync(this.logFilePath)) {\n      return {\n        totalCalls: 0,\n        totalTokens: 0,\n        totalCost: 0,\n        byModel: {},\n      };\n    }\n\n    try {\n      const content = fs.readFileSync(this.logFilePath, 'utf-8');\n      const lines = content.trim().split('\\n').filter(line => line.trim());\n\n      let totalCalls = 0;\n      let totalTokens = 0;\n      let totalCost = 0;\n      const byModel: Record<string, { calls: number; tokens: number; cost: number }> = {};\n\n      for (const line of lines) {\n        try {\n          const entry: LLMLogEntry = JSON.parse(line);\n          \n          totalCalls++;\n          totalTokens += entry.total_tokens;\n          totalCost += entry.total_cost;\n\n          if (!byModel[entry.model]) {\n            byModel[entry.model] = { calls: 0, tokens: 0, cost: 0 };\n          }\n          byModel[entry.model].calls++;\n          byModel[entry.model].tokens += entry.total_tokens;\n          byModel[entry.model].cost += entry.total_cost;\n        } catch (parseError) {\n          // Skip malformed lines\n          log.debug(`Skipping malformed log line: ${line.substring(0, 50)}...`);\n        }\n      }\n\n      return { totalCalls, totalTokens, totalCost, byModel };\n    } catch (error) {\n      log.error(`Error reading log file: ${error}`);\n      return {\n        totalCalls: 0,\n        totalTokens: 0,\n        totalCost: 0,\n        byModel: {},\n      };\n    }\n  }\n\n  /**\n   * Print usage summary\n   */\n  printUsageSummary(): void {\n    const usage = this.getTotalUsage();\n\n    log.info('========== LLM USAGE SUMMARY ==========');\n    log.info(`Total calls: ${usage.totalCalls}`);\n    log.info(`Total tokens: ${usage.totalTokens.toLocaleString()}`);\n    log.info(`Total cost: $${usage.totalCost.toFixed(4)}`);\n    log.info('');\n    log.info('By model:');\n    for (const [model, stats] of Object.entries(usage.byModel)) {\n      log.info(\n        `  ${model}: ${stats.calls} calls, ` +\n        `${stats.tokens.toLocaleString()} tokens, ` +\n        `$${stats.cost.toFixed(4)}`\n      );\n    }\n    log.info('=======================================');\n  }\n\n  /**\n   * Clear log file\n   */\n  clearLogs(): void {\n    try {\n      if (fs.existsSync(this.logFilePath)) {\n        fs.unlinkSync(this.logFilePath);\n        log.info(`Cleared log file: ${this.logFilePath}`);\n      }\n    } catch (error) {\n      log.error(`Failed to clear logs: ${error}`);\n    }\n  }\n}\n\n/**\n * Global LLM logger instance\n */\nexport const llmLogger = new LLMLogger();\n"],
  "mappings": "AAOA,YAAY,QAAQ;AACpB,YAAY,UAAU;AACtB,SAAS,oBAAoB;AAC7B,SAAS,yBAAyB;AAGlC,MAAM,MAAM,aAAa,WAAW;AAKpC,MAAM,gBAAmE;AAAA,EACvE,eAAe;AAAA,IACb,OAAO;AAAA;AAAA,IACP,QAAQ;AAAA;AAAA,EACV;AAAA,EACA,UAAU;AAAA,IACR,OAAO;AAAA;AAAA,IACP,QAAQ;AAAA;AAAA,EACV;AAAA,EACA,SAAS;AAAA,IACP,OAAO;AAAA;AAAA,IACP,QAAQ;AAAA;AAAA,EACV;AAAA,EACA,iBAAiB;AAAA,IACf,OAAO;AAAA;AAAA,IACP,QAAQ;AAAA;AAAA,EACV;AACF;AAoBO,MAAM,UAAU;AAAA,EAGrB,YAAY,cAAsB,kBAAkB;AAClD,UAAM,aAAa,kBAAkB;AACrC,UAAM,eAAe,KAAK,KAAK,YAAY,QAAQ;AAGnD,QAAI,CAAC,GAAG,WAAW,YAAY,GAAG;AAChC,SAAG,UAAU,cAAc,EAAE,WAAW,KAAK,CAAC;AAAA,IAChD;AAEA,SAAK,cAAc,KAAK,KAAK,cAAc,WAAW;AACtD,QAAI,MAAM,2BAA2B,KAAK,WAAW,EAAE;AAAA,EACzD;AAAA;AAAA;AAAA;AAAA,EAKA,WACE,UACA,UACA,OACA,OACA,eAAuB,QACjB;AACN,UAAM,eAAc,oBAAI,KAAK,GAAE,YAAY;AAG3C,UAAM,UAAU,cAAc,KAAK,KAAK,cAAc,aAAa;AACnE,UAAM,YACJ,MAAM,eAAe,QAAQ,QAC7B,MAAM,gBAAgB,QAAQ;AAGhC,QAAI;AAAA,MACF,UAAU,KAAK,aAAa,MAAM,YAAY,QACvC,MAAM,YAAY,SAAS,MAAM,aAAa,aAC3C,UAAU,QAAQ,CAAC,CAAC;AAAA,IAChC;AAGA,UAAM,WAAwB;AAAA,MAC5B;AAAA,MACA,MAAM;AAAA,MACN;AAAA,MACA;AAAA,MACA,cAAc,MAAM;AAAA,MACpB,cAAc,MAAM;AAAA,MACpB,eAAe,MAAM;AAAA,MACrB,YAAY;AAAA,MACZ,eAAe;AAAA,IACjB;AAGA,QAAI;AACF,YAAM,UAAU,KAAK,UAAU,UAAU,MAAM,CAAC,IAAI;AACpD,SAAG,eAAe,KAAK,aAAa,SAAS,OAAO;AACpD,UAAI,MAAM,kBAAkB,KAAK,WAAW,EAAE;AAAA,IAChD,SAAS,OAAO;AACd,UAAI,KAAK,sBAAsB,KAAK,WAAW,KAAK,KAAK,EAAE;AAAA,IAC7D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,gBAKE;AACA,QAAI,CAAC,GAAG,WAAW,KAAK,WAAW,GAAG;AACpC,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,aAAa;AAAA,QACb,WAAW;AAAA,QACX,SAAS,CAAC;AAAA,MACZ;AAAA,IACF;AAEA,QAAI;AACF,YAAM,UAAU,GAAG,aAAa,KAAK,aAAa,OAAO;AACzD,YAAM,QAAQ,QAAQ,KAAK,EAAE,MAAM,IAAI,EAAE,OAAO,UAAQ,KAAK,KAAK,CAAC;AAEnE,UAAI,aAAa;AACjB,UAAI,cAAc;AAClB,UAAI,YAAY;AAChB,YAAM,UAA2E,CAAC;AAElF,iBAAW,QAAQ,OAAO;AACxB,YAAI;AACF,gBAAM,QAAqB,KAAK,MAAM,IAAI;AAE1C;AACA,yBAAe,MAAM;AACrB,uBAAa,MAAM;AAEnB,cAAI,CAAC,QAAQ,MAAM,KAAK,GAAG;AACzB,oBAAQ,MAAM,KAAK,IAAI,EAAE,OAAO,GAAG,QAAQ,GAAG,MAAM,EAAE;AAAA,UACxD;AACA,kBAAQ,MAAM,KAAK,EAAE;AACrB,kBAAQ,MAAM,KAAK,EAAE,UAAU,MAAM;AACrC,kBAAQ,MAAM,KAAK,EAAE,QAAQ,MAAM;AAAA,QACrC,SAAS,YAAY;AAEnB,cAAI,MAAM,gCAAgC,KAAK,UAAU,GAAG,EAAE,CAAC,KAAK;AAAA,QACtE;AAAA,MACF;AAEA,aAAO,EAAE,YAAY,aAAa,WAAW,QAAQ;AAAA,IACvD,SAAS,OAAO;AACd,UAAI,MAAM,2BAA2B,KAAK,EAAE;AAC5C,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,aAAa;AAAA,QACb,WAAW;AAAA,QACX,SAAS,CAAC;AAAA,MACZ;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,oBAA0B;AACxB,UAAM,QAAQ,KAAK,cAAc;AAEjC,QAAI,KAAK,yCAAyC;AAClD,QAAI,KAAK,gBAAgB,MAAM,UAAU,EAAE;AAC3C,QAAI,KAAK,iBAAiB,MAAM,YAAY,eAAe,CAAC,EAAE;AAC9D,QAAI,KAAK,gBAAgB,MAAM,UAAU,QAAQ,CAAC,CAAC,EAAE;AACrD,QAAI,KAAK,EAAE;AACX,QAAI,KAAK,WAAW;AACpB,eAAW,CAAC,OAAO,KAAK,KAAK,OAAO,QAAQ,MAAM,OAAO,GAAG;AAC1D,UAAI;AAAA,QACF,KAAK,KAAK,KAAK,MAAM,KAAK,WACvB,MAAM,OAAO,eAAe,CAAC,aAC5B,MAAM,KAAK,QAAQ,CAAC,CAAC;AAAA,MAC3B;AAAA,IACF;AACA,QAAI,KAAK,yCAAyC;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAKA,YAAkB;AAChB,QAAI;AACF,UAAI,GAAG,WAAW,KAAK,WAAW,GAAG;AACnC,WAAG,WAAW,KAAK,WAAW;AAC9B,YAAI,KAAK,qBAAqB,KAAK,WAAW,EAAE;AAAA,MAClD;AAAA,IACF,SAAS,OAAO;AACd,UAAI,MAAM,yBAAyB,KAAK,EAAE;AAAA,IAC5C;AAAA,EACF;AACF;AAKO,MAAM,YAAY,IAAI,UAAU;",
  "names": []
}
