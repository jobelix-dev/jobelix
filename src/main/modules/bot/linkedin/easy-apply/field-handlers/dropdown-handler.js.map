{
  "version": 3,
  "sources": ["dropdown-handler.ts"],
  "sourcesContent": ["/**\n * Dropdown Handler - Handles <select> elements in LinkedIn forms\n * \n * Dropdowns are used for: Phone country code, Years of experience, Education level, Schools\n */\n\nimport type { Locator } from 'playwright';\nimport { BaseFieldHandler } from './base-handler';\nimport { createLogger } from '../../../utils/logger';\nimport { TIMEOUTS } from '../selectors';\n\nconst log = createLogger('DropdownHandler');\n\n/** Maximum options to send to GPT (to avoid \"message too long\" errors) */\nconst MAX_OPTIONS_FOR_GPT = 100;\n\nexport class DropdownHandler extends BaseFieldHandler {\n  /**\n   * Check if this element contains a select dropdown\n   */\n  async canHandle(element: Locator): Promise<boolean> {\n    try {\n      return await element.locator('select').count() > 0;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Handle a dropdown select field\n   */\n  async handle(element: Locator): Promise<boolean> {\n    try {\n      const select = element.locator('select').first();\n      if (await select.count() === 0) return false;\n\n      const questionText = await this.extractQuestionText(element);\n      log.debug(`Question: \"${questionText}\"`);\n\n      const options = await this.extractOptions(select);\n      if (options.length === 0) {\n        log.warn('No options found for dropdown');\n        return false;\n      }\n\n      log.debug(`Options: ${options.slice(0, 5).join(', ')}${options.length > 5 ? '...' : ''}`);\n\n      // Always ask GPT (don't use saved answers or smart matching)\n      log.debug(`Asking GPT: \"${questionText}\"`);\n      const truncatedOptions = this.truncateOptionsForGPT(options, questionText);\n      const answer = await this.gptAnswerer.answerFromOptions(questionText, truncatedOptions);\n      \n      if (!answer?.trim()) {\n        log.warn('No answer available for dropdown');\n        return false;\n      }\n\n      log.info(`\u2705 Q: \"${questionText}\" \u2192 \"${answer}\"`);\n\n      // Select the option\n      if (!await this.selectOption(select, options, answer)) {\n        log.warn(`Could not find matching option for: \"${answer}\"`);\n        return false;\n      }\n\n      this.formUtils.rememberAnswer('dropdown', questionText, answer);\n\n      // Handle validation errors\n      await this.handleValidationError(\n        element, 'dropdown', questionText, answer,\n        (q, a, e) => this.gptAnswerer.answerFromOptionsWithRetry(q, options, a, e),\n        async (retryAnswer) => { await this.selectOption(select, options, retryAnswer); }\n      );\n\n      return true;\n    } catch (error) {\n      log.error(`Error handling dropdown: ${error}`);\n      return false;\n    }\n  }\n\n  /**\n   * Smart matching for school fields only (to match resume school name to dropdown options)\n   */\n  private smartMatchSchool(questionText: string, options: string[]): string | undefined {\n    const questionLower = questionText.toLowerCase();\n\n    // School/University detection\n    if (this.isSchoolField(questionLower)) {\n      log.debug('[SMART MATCH] Detected school/university field');\n      const matcher = this.createSmartMatcher();\n      return matcher.matchSchool(options) ?? undefined;\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Check if this is a school/university field\n   */\n  private isSchoolField(questionLower: string): boolean {\n    return (\n      questionLower.includes('school') ||\n      questionLower.includes('university') ||\n      questionLower.includes('college') ||\n      questionLower.includes('institution')\n    );\n  }\n\n  /**\n   * Truncate options for GPT to avoid \"message too long\" errors\n   */\n  private truncateOptionsForGPT(options: string[], questionText: string): string[] {\n    if (options.length <= MAX_OPTIONS_FOR_GPT) return options;\n\n    log.warn(`Large dropdown (${options.length} options) - truncating to ${MAX_OPTIONS_FOR_GPT}`);\n    \n    if (this.isSchoolField(questionText.toLowerCase())) {\n      log.error(`[SCHOOL] Could not find resume school - GPT will only see first ${MAX_OPTIONS_FOR_GPT}`);\n    }\n    \n    return options.slice(0, MAX_OPTIONS_FOR_GPT);\n  }\n\n  /**\n   * Extract options from select element (skip placeholders)\n   */\n  private async extractOptions(select: Locator): Promise<string[]> {\n    const options: string[] = [];\n    const optionElements = await select.locator('option').all();\n\n    for (let i = 0; i < optionElements.length; i++) {\n      try {\n        const opt = optionElements[i];\n        const text = await opt.textContent();\n        const value = await opt.getAttribute('value');\n\n        // Skip placeholder options\n        if (i === 0 && (!value || text?.toLowerCase().includes('select'))) {\n          continue;\n        }\n\n        if (text?.trim()) {\n          options.push(text.trim());\n        }\n      } catch {\n        // Skip problematic options\n      }\n    }\n\n    return options;\n  }\n\n  /**\n   * Select option by label (handles minor text differences)\n   */\n  private async selectOption(select: Locator, options: string[], answer: string): Promise<boolean> {\n    const normalizedAnswer = this.normalizeText(answer);\n\n    // Try exact match\n    for (const option of options) {\n      if (this.normalizeText(option) === normalizedAnswer) {\n        try {\n          await select.selectOption({ label: option });\n          await this.page.waitForTimeout(TIMEOUTS.medium);\n          return true;\n        } catch (error) {\n          log.debug(`Failed to select \"${option}\": ${error}`);\n        }\n      }\n    }\n\n    // Try partial match\n    for (const option of options) {\n      const normalizedOption = this.normalizeText(option);\n      if (normalizedOption.includes(normalizedAnswer) || normalizedAnswer.includes(normalizedOption)) {\n        try {\n          await select.selectOption({ label: option });\n          await this.page.waitForTimeout(TIMEOUTS.medium);\n          return true;\n        } catch {\n          continue;\n        }\n      }\n    }\n\n    return false;\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
